<?xml version="1.0" encoding="windows-1251" ?>

<!DOCTYPE page [
<!ENTITY nbsp "&#160;">
<!ENTITY пробел "&#160;">
<!ENTITY shy "&#173;">
<!ENTITY перенос "&#173;">
]>

<?xml:stylesheet type="text/xsl" href="../common/layout.xsl" ?>
<Урок xmlns="x-schema:Schema.xml" название="MySQL"  предыдущий="index.xml" следующий="section02.xml">
<H2> Файлы журналов </H2>
<P>Журналы сервера MySQL&nbsp;являются мощнейшим оружием в руках&nbsp;грамотного администратора. Они 
помогают решать многие задачи, в том числе безопасности 
и восстановления таблиц после сбоев.&nbsp;Существует два основных типа журналов, 
которые может сгенерировать сервер по указанию администратора. </P>
<UL>
  <LI><STRONG>Файл общего журнала</STRONG>. Он содержит информацию о подключениях клиентов, запросах и другого 
  рода событиях. Этот файл исключительно полезен для отслеживания деятельности 
  сервера: кто подключен, откуда и что делает.&nbsp; Например: 
  <pre>MySql, Version: 3.23.40-nt-log, started with:
TCP Port: 3306, Named Pipe: MySQL
Time                 Id Command    Argument
030218  0:43:36	     1 Connect     root@localhost on 
		           1 Query       show status
		           1 Query       show databases like '%'
		           1 Processlist
		           1 Query       show variables
030218  0:43:46	     1 Query       show status 
</pre> </LI>
  <LI>&nbsp;<STRONG>Журнал обновлений</STRONG>. Этот файл содержит запросы, 
  изменяющие базу данных. Несмотря на название, этот журнал содержит записи не 
  только операторов UPDATE, но и многих других, используемых для изменения базы 
  данных, например, DELETE, INSERT, REPLACE, CREATE TABLE, DROP TABLE, GRANT и 
  REVOKE. Содержимое журнала обновлений представлено в виде операторов SQL. 
  Форма записи этих операторов позволяет использовать их для ввода в mysql. В 
  комбинации с резервированием этот журнал становится эффективным средством 
  восстановления таблиц после сбоя. Достаточно восстановить базу данных из 
  файлов архива, а затем запустить повторно все запросы на изменение базы данных с момента последней архивации, используя записи 
  журнала обновлений в качестве ввода для mysql. Эти действия 
  позволят восстановить таблицы в состояние, в котором они 
  находились перед самым сбоем. 
   </LI></UL>     
       
<p>Для активизации процесса регистрации используются опции --log &nbsp;и&nbsp;--log-update. Первая приводит к созданию и ведению 
  общего журнала, вторая — журнала обновлений. Эти опции можно определить в 
  командной строке при запуске&nbsp;сервера (mysqld.exe), а также в группе [mysqld] 
  конфигурационного файла.
 При активизации регистрации файлы журналов по умолчанию записываются в 
каталоге данных сервера(c:/mysql/data). При первом запуске сервера MySQL 
рекомендуется активизировать оба типа регистрации. Впоследствии можно оставить 
только журнал обновлений, чтобы уменьшить объем занимаемого дискового 
пространства. 
</p>
  <p>Например, файл my.ini может выглядеть так:</p>
  <pre>
  #This File was made using the WinMySQLAdmin 1.2 Tool
#28.11.2002 14:24:58

#Uncomment or Add only the keys that you know how works.
#Read the MySQL Manual for instructions

[mysqld]
<font color="red">log-update= update</font>
basedir=c:/mysql
#bind-address=127.0.0.1
datadir= c:/mysql/data
#language=c:/mysql/share/your_languagedirectory
#slow query log#=
#tmpdir#=
#port=3306
#set-variable=key_buffer=16M
[WinMySQLadmin]
Server=c:/mysql/bin/mysqld-nt.exe
user=root
password=password
  </pre>
<p>При этом в файл  update.log будут производиться записи  вида:
<pre>
# MySql, Version: 3.23.40-nt-log at 030218  0:46:51
use Groups;
DELETE FROM student WHERE id=44;
# MySql, Version: 3.23.40-nt-log at 030218  1:05:52
use Groups;
DELETE FROM student WHERE id=21; 
</pre></p>
<P>Если администратор указывает серверу имя файла журнала 
обновлений без расширения, например, update, сервер автоматически генерирует 
имена журналов, согласно последовательности update. 001, update. 002 и т.п. Новый файл журнала создается 
каждый раз при запуске сервера или заполнении старого 
журнала. Если при активизации регистрации администратор не указывает имя файла для 
журнала, сервер генерирует такую же последовательность, выбирая в качестве основной части 
имени файла имя локального компьютера. Это может быть выгодно 
для серверов с большой нагрузкой. На небольших серверах удобнее 
выполнять ротацию журналов по мере их заполнения. </P>
<P>Активизировав регистрацию, необходимо периодически проверять диск, чтобы он 
не заполнился огромным количеством регистрационной информации. Особенно это 
касается загруженных серверов, обрабатывающих большое число запросов. 
Рекомендуется периодически удалять и заменять файлы журналов, чтобы всегда иметь 
самую последнюю учетную информацию и в то же время не позволять файлам журналов 
разрастаться до огромных размеров.</P>
<P>Ротация файлов журналов выполняется следующим образом. Предположим, файл 
журнала имеет имя log. На первом этапе он переименавывается в log.0, и сервер 
приступает к записи нового файла log. На втором этапе файл log.0 
переименовывается в log.1, файл log — в log.0, а сервер приступает к записи 
нового файла log. В этом случае каждому файлу последовательно присваиваются 
имена log.0, log.1 и т.п. По достижении определенного этапа файл 
стирается.&nbsp;При желании можно написать простенькое приложение на С++, 
которое будет делать это автоматически.</P>
<P>Журналы обновлений и операторы LOAD DATA </P>
<P>В настоящее время при выполнении оператора LOAD DATA сервер записывает в 
журнал обновлений только собственно оператор без содержимого&nbsp;загружаемых 
строк. Это означает, что в процессе последующего восстановления с применением 
журналов обновлений данные будут восстановлены не полностью из-за недоступности 
файла данных. Поэтому не удаляйте файл данных до полного резервирования базы 
данных.</P>
<P>&nbsp;Резервирование системы </P>
<P>Журналы обновлений не смогут выполнить свою функцию, если в результате сбоя в 
работе диска будут потеряны. Именно поэтому следует обязательно и регулярно 
выполнять резервирование всей файловой системы. Хорошая идея — записывать 
журналы обновлений на другой диск(ведь CD-RW сегодня стоит не так 
дорого). Если ротация файлов журналов выполняется ежедневно и 
администратор считает, что нужно хранить журналы только за последнюю неделю, 
достаточно хранить их файлы log.0 — log.6. На следующем этапе ротации старый 
файл log.6 можно удалить, после чего переименовать файл log.5 в новый файл 
log.6.&nbsp;При таком&nbsp;подходе всегда будет оставаться нужное число журналов 
и в то же время&nbsp;диск не будет переполняться информацией. Частота ротации 
файлов и число старых журналов определяется, в&nbsp; первую очередь, 
загруженностью сервера (активные серверы генерируют&nbsp;значительно больше 
информации регистрации) и наличием свободного пространства. </P>

</Урок>
